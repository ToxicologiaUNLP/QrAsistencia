<!DOCTYPE html>
<html lang="es-AR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Laboratorio Central</title>
<style>
:root{
  --bg:#61adc1;
  --text:#002b36;
  --muted:#275b67;
  --card:#ffffff;
  --shade: rgba(0,0,0,.08);
}
*{box-sizing:border-box;}
body{
  margin:0; font-family: Arial, Helvetica, sans-serif;
  background: var(--bg); color: var(--text);
}
header{
  background: var(--card);
  padding: 24px 16px;
  text-align:center;
  box-shadow: 0 2px 12px var(--shade);
}
header img{
  display:block; margin:0 auto 10px;
  max-width: 220px; width: 125%;
}
header h1{
  margin: 6px 0 4px; font-size: 28px; color: #003d4d;
}
header h2{
  margin:0; font-weight: normal; color: #0b6a7f;
  font-size: 16px;
}
main{
  max-width: 1280px;
  margin: 28px auto; padding: 24px;
  background: var(--card); border-radius: 14px;
  box-shadow: 0 6px 24px var(--shade);
  position: relative;
}
.status{
  margin-bottom: 12px; padding: 10px 12px; border-radius: 8px;
  font-size: 14px;
  background: #eef6ff; border:1px solid #cfe8ff; color:#0b4a6d;
}
.status.ok{ background:#eefaf1; border-color:#cfeedd; color:#205b3a;}
.status.err{ background:#fff2f2; border-color:#ffd0d0; color:#7a1c1c;}
.search-wrap{ position: relative; margin-bottom:12px; }
#searchBox{
  width:100%; padding:12px 14px; font-size:16px;
  border:1px solid #cfd8dc; border-radius:10px; outline:none;
}
#searchBox:focus{ border-color:#7ab8c6; box-shadow: 0 0 0 3px rgba(122,184,198,.25); }
#suggestions{
  position: absolute; left:0; right:0; top: calc(100% + 6px);
  background: #fff; border:1px solid #dfe7ea; border-radius: 10px;
  box-shadow: 0 10px 24px rgba(0,0,0,.08);
  max-height: 300px; overflow-y: auto; display:none; z-index: 20;
}
.suggestion{
  padding: 10px 12px; cursor: pointer;
  border-bottom: 1px solid #f1f3f5;
}
.suggestion:last-child{ border-bottom: 0; }
.suggestion:hover{ background:#f5fbfd; }
.suggestion.selected{ background: #d0f0f8; }
.details{
  margin-top: 18px;
  overflow-x: auto;
}
table{
  border-collapse: collapse;
  table-layout: auto;      /* ✅ que cada columna se ajuste al contenido */
  width: max-content;      /* ✅ que la tabla se expanda según contenido */
  min-width: 100%;         /* ✅ ocupa siempre al menos todo el ancho */
}
th, td{
  border: 1px solid #333;
  padding: 6px 10px;
  text-align: left;
  vertical-align: top;
  white-space: nowrap;     /* ✅ siempre en horizontal */
}
td{
  white-space: pre-wrap;   /* ✅ respeta saltos, pero mantiene horizontal */
}
/* Columna de Valores de referencia (4ta) */
td:nth-child(4),
th:nth-child(4){
  white-space: pre-wrap; /* respeta saltos de línea del Sheets */
}
</style>
</head>
<body>
<header>
  <img src="logolab.png" alt="Logo del Laboratorio">
  <h1>Laboratorio Central</h1>
  <h2>Valores de referencia y condiciones en la toma de muestra</h2>
</header>
<main>
  <div id="status" class="status">Cargando datos…</div>
  <div class="search-wrap">
    <input id="searchBox" type="text" placeholder="Escriba el tipo de estudio aquí" autocomplete="off" />
    <div id="suggestions"></div>
  </div>
  <div id="result" class="details"></div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT_1_DpeDPmqZOjSmtIGeb8Ri-yuGtWz7sWwwFMdyWssacb5RTdJkpu_7OBPi_yPw/pub?output=csv";

// Evitar caché
function getNoCacheUrl(){
  return CSV_URL + "&t=" + Date.now();
}

const statusEl = document.getElementById('status');
const inputEl = document.getElementById('searchBox');
const sugEl = document.getElementById('suggestions');
const resultDiv = document.getElementById('result');

let rows = [];
let headers = [];
let studyKey = null;
let selectedIndex = -1;

const normHeader = h => (h||"").toString().replace(/\r/g,'').trim();
const normText = t => (t||"").toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();

function loadData(){
  Papa.parse(getNoCacheUrl(), {
    download: true,
    header: true,
    skipEmptyLines: true,
    dynamicTyping: false,
    complete: function(res){
      try{
        // ✅ Filtrar headers vacíos
        headers = (res.meta.fields || Object.keys(res.data[0] || {}))
          .map(normHeader)
          .filter(h => h !== "");

        rows = res.data.map(obj=>{
          const clean = {};
          for(const [k,v] of Object.entries(obj)){
            const nk = normHeader(k);
            if(headers.includes(nk)){  // ✅ solo guardamos columnas con título
              clean[nk] = (v==null?"":String(v).replace(/\r/g,'').trim());
            }
          }
          return clean;
        }).filter(r=>Object.keys(r).length>0);

        studyKey = headers.find(h=>normHeader(h).toUpperCase()==="ESTUDIO") 
                 || headers.find(h=>normHeader(h).toUpperCase()==="ESTUDIOS");

        if(!rows.length) throw new Error("El CSV no contiene filas de datos.");
        if(!studyKey) throw new Error('No se encontró la columna "ESTUDIO" en el CSV.');

        statusEl.textContent = `Datos cargados: ${rows.length} estudios.`;
        statusEl.className = "status ok";
      }catch(err){
        statusEl.textContent = err.message;
        statusEl.className = "status err";
      }
    },
    error: function(err){
      statusEl.textContent = "Error al cargar el CSV: "+err;
      statusEl.className = "status err";
    }
  });
}

loadData();

inputEl.addEventListener('input', ()=>{
  const q = normText(inputEl.value);
  sugEl.innerHTML = "";
  selectedIndex = -1;
  if(!q || !rows.length || !studyKey){
    sugEl.style.display="none";
    resultDiv.innerHTML = "";
    return;
  }
  const matches = rows.filter(r=>normText(r[studyKey]).includes(q)).slice(0,50);
  if(!matches.length){
    sugEl.style.display="none";
    resultDiv.innerHTML = "";
    return;
  }
  sugEl.style.display="block";
  matches.slice(0,12).forEach(r=>{
    const div = document.createElement('div');
    div.className = 'suggestion';
    div.textContent = r[studyKey];
    div.onclick = ()=>showTable(r);
    sugEl.appendChild(div);
  });
});

inputEl.addEventListener('keydown', (e)=>{
  const items = sugEl.querySelectorAll('.suggestion');
  if(items.length === 0) return;

  if(e.key === 'ArrowDown'){
    e.preventDefault();
    selectedIndex = (selectedIndex + 1) % items.length;
    updateSelection(items);
  } else if(e.key === 'ArrowUp'){
    e.preventDefault();
    selectedIndex = (selectedIndex - 1 + items.length) % items.length;
    updateSelection(items);
  } else if(e.key === 'Enter'){
    e.preventDefault();
    if(selectedIndex >= 0 && selectedIndex < items.length){
      items[selectedIndex].click();
      selectedIndex = -1;
    } else if(items.length > 0){
      items[0].click();
    }
  }
});

function updateSelection(items){
  items.forEach((el,i)=>{
    if(i === selectedIndex){
      el.classList.add('selected');
      el.scrollIntoView({block:'nearest'});
    } else {
      el.classList.remove('selected');
    }
  });
}

function showTable(row){
  sugEl.style.display="none";
  inputEl.value = row[studyKey] || "";

  resultDiv.innerHTML = `<table>
    <thead>
      <tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr>
    </thead>
    <tbody>
      <tr>${headers.map(h=>`<td>${row[normHeader(h)] || ''}</td>`).join('')}</tr>
    </tbody>
  </table>`;
}

// Auto-refresh cada 30s
setInterval(loadData, 30000);
</script>
</body>
</html>



